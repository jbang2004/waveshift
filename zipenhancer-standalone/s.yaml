# Serverless Devs é…ç½®æ–‡ä»¶
# ç”¨äºéƒ¨ç½²é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—3.0 GPUé™å™ªæœåŠ¡

edition: 3.0.0          # Serverless Devsç‰ˆæœ¬
name: zipenhancer-gpu-app    # åº”ç”¨åç§°
access: default         # è®¿é—®å‡­è¯é…ç½®åç§°

vars:
  region: ap-southeast-1   # ğŸŒ é˜¿é‡Œäº‘åŒºåŸŸ (æ–°åŠ å¡ï¼Œæ”¯æŒGPU)
  functionName: zipenhancer-gpu
  serviceName: audio-processing

resources:
  zipenhancer-gpu:   # èµ„æºåç§°
    component: fc3      # ä½¿ç”¨FC 3.0ç»„ä»¶
    props:
      region: ${vars.region}
      
      # å‡½æ•°é…ç½®
      function:
        functionName: ${vars.functionName}
        description: "ZipEnhancer GPUé™å™ªæœåŠ¡ - åŸºäºONNX Runtimeçš„é«˜æ€§èƒ½éŸ³é¢‘é™å™ª"
        handler: fc_handler.handler
        
        # è¿è¡Œæ—¶é…ç½®
        runtime: custom-container
        
        # è‡ªå®šä¹‰å®¹å™¨é…ç½®
        customContainerConfig:
          # ğŸ¯ å®¹å™¨é•œåƒåœ°å€
          image: crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/zipenhancer-gpu:latest
          port: 9000
          
          # ACRé•œåƒå‡­è¯é…ç½®
          acrRegistry:
            id: crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com
            
        # ğŸ–¥ï¸ GPUé…ç½®
        gpuConfig:
          gpuMemorySize: 4096      # 4GB GPUå†…å­˜
          gpuType: fc.gpu.tesla.1  # Tesla T4 GPU
        
        # ğŸ”§ èµ„æºé…ç½®
        memorySize: 8192    # 8GBå†…å­˜ï¼ˆGPUæ¨¡å¼éœ€è¦æ›´å¤šå†…å­˜ï¼‰
        cpu: 2              # 2 vCPU
        diskSize: 512       # 512MBä¸´æ—¶ç£ç›˜
        timeout: 300        # 5åˆ†é’Ÿè¶…æ—¶ï¼ˆå¤„ç†é•¿éŸ³é¢‘ï¼‰
        
        # ç¯å¢ƒå˜é‡
        environmentVariables:
          PYTHONUNBUFFERED: "1"
          CUDA_VISIBLE_DEVICES: "0"
          OMP_NUM_THREADS: "1"
          # ONNX Runtimeä¼˜åŒ–
          ORT_TENSORRT_ENGINE_CACHE_ENABLE: "1"
          ORT_TENSORRT_ENGINE_CACHE_PATH: "/tmp/tensorrt_cache"
          
        # ğŸŒ ç½‘ç»œé…ç½®
        internetAccess: true
        
        # ğŸ“Š æ—¥å¿—é…ç½®
        logConfig:
          project: fc-zipenhancer-logs
          logstore: function-logs
          enableRequestMetrics: true
          enableInstanceMetrics: true
        
        # ğŸš€ å®ä¾‹é…ç½®
        instanceConcurrency: 1      # GPUå®ä¾‹å¹¶å‘æ•°é™åˆ¶ä¸º1
        instanceType: fc.gpu.tesla.1   # GPUå®ä¾‹ç±»å‹
        
        # ğŸ”¥ ç”Ÿäº§ç¯å¢ƒé…ç½®
        instanceLifecycleConfig:
          initializer:              # åˆå§‹åŒ–å‡½æ•°
            handler: fc_handler.initialize
            timeout: 60             # åˆå§‹åŒ–è¶…æ—¶60ç§’
            
        # é¢„ç•™å®ä¾‹é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºæ¶ˆé™¤å†·å¯åŠ¨ï¼‰
        # provisionedConcurrencyConfig:
        #   target: 1                 # é¢„ç•™1ä¸ªGPUå®ä¾‹
        #   scheduledActions:         # å®šæ—¶ä¼¸ç¼©è§„åˆ™
        #     - name: "business-hours"
        #       schedule: "0 9 * * *"  # æ¯å¤©9ç‚¹æ‰©å®¹
        #       target: 2
        #     - name: "off-hours" 
        #       schedule: "0 22 * * *" # æ¯å¤©22ç‚¹ç¼©å®¹
        #       target: 1
        
      # HTTPè§¦å‘å™¨é…ç½®
      triggers:
        - name: http-trigger
          type: http
          config:
            authType: anonymous     # ğŸ”“ åŒ¿åè®¿é—®ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®æ”¹ä¸ºfunctionï¼‰
            methods:
              - GET                 # å¥åº·æ£€æŸ¥
              - POST                # éŸ³é¢‘å¤„ç†
              - OPTIONS             # CORSé¢„æ£€
            
            # è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰
            # customDomain:
            #   domainName: denoise.example.com
            #   protocol: HTTPS
            #   certId: your-cert-id
            #   routeConfig:
            #     - path: /*
            
            # CORSé…ç½®
            cors:
              allowOrigin: "*"
              allowMethods: 
                - GET
                - POST
                - OPTIONS
              allowHeaders:
                - Content-Type
                - X-Segment-Id
                - X-Speaker
                - X-Enable-Streaming
                - X-Input-Format
              exposeHeaders:
                - X-Denoise-Applied
                - X-Model
                - X-Device
                - X-Processing-Time
              maxAge: 3600
              
      # å¼‚æ­¥é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºé•¿æ—¶é—´å¤„ç†ï¼‰
      # asyncInvokeConfig:
      #   maxAsyncEventAgeInSeconds: 3600
      #   maxAsyncRetryAttempts: 3
      #   destinationConfig:
      #     onSuccess:
      #       destination: acs:fc:${vars.region}:${vars.accountId}:functions/${vars.functionName}/success
      #     onFailure:
      #       destination: acs:fc:${vars.region}:${vars.accountId}:functions/${vars.functionName}/failure

# è‡ªå®šä¹‰å‘½ä»¤
actions:
  pre-deploy:
    - run: echo "ğŸš€ å¼€å§‹éƒ¨ç½²ZipEnhancer GPUé™å™ªæœåŠ¡..."
    - run: echo "ğŸ“¦ é•œåƒåœ°å€ï¼šcrpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/zipenhancer-gpu:latest"
  
  post-deploy:
    - run: echo "âœ… éƒ¨ç½²å®Œæˆï¼"
    - run: echo "ğŸŒ è®¿é—®åœ°å€ï¼šhttps://${vars.functionName}.${vars.region}.fcapp.run"
    - run: echo "ğŸ“ å¥åº·æ£€æŸ¥ï¼šcurl https://${vars.functionName}.${vars.region}.fcapp.run/health"