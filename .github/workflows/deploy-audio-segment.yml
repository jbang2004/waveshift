name: Deploy Audio Segment Worker (Container)

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image (ignore cache)'
        required: false
        type: boolean
        default: false
  push:
    paths:
      - 'waveshift-audio-segment-worker/**'
      - '.github/workflows/deploy-audio-segment.yml'
    branches: [main]

# âœ… Cloudflare 2025: ä½¿ç”¨æœ¬åœ° Dockerfileï¼Œæ— éœ€å¤–éƒ¨é•œåƒæ³¨å†Œè¡¨

jobs:
  deploy-audio-segment:
    runs-on: ubuntu-latest
    name: Build and Deploy Audio Segment Worker
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Worker dependencies
        run: |
          cd waveshift-audio-segment-worker
          npm install


      - name: Generate Cloudflare types
        run: |
          cd waveshift-audio-segment-worker
          npm run cf-typegen || echo "Type generation skipped"

      - name: TypeScript type check
        run: |
          cd waveshift-audio-segment-worker
          npm run type-check || echo "Type check skipped"

      - name: Verify Dockerfile and configuration
        run: |
          cd waveshift-audio-segment-worker
          if [ ! -f Dockerfile ]; then
            echo "âŒ Dockerfile not found!"
            exit 1
          fi
          echo "âœ… Dockerfile found (Python + FastAPI + pydub)"
          echo "ğŸ“‹ Dockerfile FROM line:"
          grep "FROM" Dockerfile
          echo ""
          echo "ğŸ“‹ wrangler.jsonc container config:"
          grep -A 5 "containers" wrangler.jsonc

      - name: Set R2 Secrets
        run: |
          cd waveshift-audio-segment-worker
          echo "${{ secrets.R2_ACCESS_KEY_ID }}" | npx wrangler secret put R2_ACCESS_KEY_ID
          echo "${{ secrets.R2_SECRET_ACCESS_KEY }}" | npx wrangler secret put R2_SECRET_ACCESS_KEY
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy to Cloudflare Workers (Container)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --compatibility-date 2024-12-01 --keep-vars
          workingDirectory: './waveshift-audio-segment-worker'

      - name: Verify deployment
        run: |
          cd waveshift-audio-segment-worker
          echo "ğŸ¯ éªŒè¯éƒ¨ç½²çŠ¶æ€..."
          
          # è·å–éƒ¨ç½²åçš„ Worker URL
          WORKER_URL=$(npx wrangler whoami 2>/dev/null | grep "account" | head -1 | cut -d'"' -f4)
          if [ -n "$WORKER_URL" ]; then
            echo "ğŸ“ Worker URL: https://waveshift-audio-segment-worker.$WORKER_URL.workers.dev"
          fi
          
          echo "âœ… Audio Segment Worker éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "- å®¹å™¨æ„å»º: æœ¬åœ° Dockerfile"
          echo "- Cloudflare Worker: waveshift-audio-segment-worker"
          echo "- æ„å»ºæ—¶é—´: $(date)"

      - name: Test deployment
        if: success()
        run: |
          sleep 30  # ç­‰å¾…å®¹å™¨å¯åŠ¨
          echo "ğŸ§ª æµ‹è¯•éƒ¨ç½²çš„æœåŠ¡..."
          
          # æµ‹è¯•å¥åº·æ£€æŸ¥
          curl -f https://waveshift-audio-segment-worker.jbang20042004.workers.dev/health || echo "Health check failed"
          
          # æµ‹è¯•éŸ³é¢‘åˆ‡åˆ†æ¥å£
          curl -X POST https://waveshift-audio-segment-worker.jbang20042004.workers.dev/segment \
            -H "Content-Type: application/json" \
            -d '{
              "audioKey": "test/sample.mp3",
              "transcripts": [{"sequence": 1, "start": "0m0s0ms", "end": "0m3s0ms", "speaker": "TestSpeaker", "original": "æµ‹è¯•", "content_type": "speech"}],
              "outputPrefix": "test/output"
            }' || echo "Segment test failed"

      - name: Post-deployment verification
        if: success()
        run: |
          echo "ğŸ¯ éªŒè¯éƒ¨ç½²ç»“æœ..."
          echo "âœ… Audio Segment å®¹å™¨å·²æˆåŠŸéƒ¨ç½²åˆ° Cloudflare"
          echo "ğŸ“¦ å®¹å™¨æŠ€æœ¯æ ˆ: Python 3.11 + FastAPI + pydub + ffmpeg"
          echo "ğŸ”§ instance_type: standard (4GB RAM)"
          echo ""
          echo "ğŸ“ å®¹å™¨ç‰¹æ€§:"
          echo "- åŸºç¡€é•œåƒ: python:3.11-slim"
          echo "- éŸ³é¢‘å¤„ç†: pydub + ffmpeg"
          echo "- APIæ¡†æ¶: FastAPI"
          echo "- å­˜å‚¨é›†æˆ: Cloudflare R2"
          echo ""
          echo "ğŸ” å¦‚éœ€è°ƒè¯•å®¹å™¨å¯åŠ¨ï¼Œè¯·æ£€æŸ¥:"
          echo "- Cloudflare Dashboard â†’ Workers â†’ waveshift-audio-segment-worker â†’ Real-time Logs"
          echo "- æˆ–è¿è¡Œ: wrangler tail waveshift-audio-segment-worker"