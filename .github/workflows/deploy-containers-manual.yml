name: Deploy Individual Containers (Manual)

on:
  workflow_dispatch:
    inputs:
      container_service:
        description: 'Which container service to deploy'
        required: true
        type: choice
        options:
          - 'audio-segment-worker'
          - 'ffmpeg-worker'
          - 'both'
      force_rebuild:
        description: 'Force rebuild containers'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy-audio-segment:
    if: ${{ github.event.inputs.container_service == 'audio-segment-worker' || github.event.inputs.container_service == 'both' }}
    runs-on: ubuntu-latest
    name: Deploy Audio Segment Worker
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd waveshift-audio-segment-worker
          npm ci
          
      - name: Deploy Audio Segment Worker
        run: |
          cd waveshift-audio-segment-worker
          echo "ğŸš€ éƒ¨ç½²éŸ³é¢‘åˆ‡åˆ†+é™å™ªæœåŠ¡..."
          
          export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          export CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          
          npm run deploy
          
      - name: Health check Audio Segment
        run: |
          echo "ğŸ©º éŸ³é¢‘åˆ‡åˆ†æœåŠ¡å¥åº·æ£€æŸ¥..."
          sleep 30
          
          if curl -f -s "https://waveshift-audio-segment-worker.jbang20042004.workers.dev/health" > /dev/null; then
            echo "âœ… éŸ³é¢‘åˆ‡åˆ†æœåŠ¡å¥åº·"
          else
            echo "âš ï¸ éŸ³é¢‘åˆ‡åˆ†æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆå¯èƒ½è¿˜åœ¨å¯åŠ¨ï¼‰"
          fi

  deploy-ffmpeg:
    if: ${{ github.event.inputs.container_service == 'ffmpeg-worker' || github.event.inputs.container_service == 'both' }}
    runs-on: ubuntu-latest
    name: Deploy FFmpeg Worker
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd waveshift-ffmpeg-worker
          npm ci
          
      - name: Deploy FFmpeg Worker
        run: |
          cd waveshift-ffmpeg-worker
          echo "ğŸš€ éƒ¨ç½²FFmpegåˆ†ç¦»æœåŠ¡..."
          
          export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          export CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          
          npm run deploy
          
      - name: Health check FFmpeg
        run: |
          echo "ğŸ©º FFmpegæœåŠ¡å¥åº·æ£€æŸ¥..."
          sleep 30
          
          # FFmpeg worker æ²¡æœ‰å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œæ‰€ä»¥åªæ£€æŸ¥åŸºæœ¬è®¿é—®
          if curl -f -s "https://waveshift-ffmpeg-worker.jbang20042004.workers.dev/" > /dev/null; then
            echo "âœ… FFmpegæœåŠ¡å¯è®¿é—®"
          else
            echo "âš ï¸ FFmpegæœåŠ¡è®¿é—®å¤±è´¥ï¼ˆå¯èƒ½è¿˜åœ¨å¯åŠ¨ï¼‰"
          fi

  summary:
    needs: [deploy-audio-segment, deploy-ffmpeg]
    if: always()
    runs-on: ubuntu-latest
    name: Deployment Summary
    
    steps:
      - name: Summary
        run: |
          echo "ğŸ‰ Containeréƒ¨ç½²å®Œæˆ!"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²è¯¦æƒ…:"
          echo "  - è¯·æ±‚æœåŠ¡: ${{ github.event.inputs.container_service }}"
          echo "  - å¼ºåˆ¶é‡å»º: ${{ github.event.inputs.force_rebuild }}"
          echo ""
          echo "ğŸ” ç›‘æ§å‘½ä»¤:"
          if [[ "${{ github.event.inputs.container_service }}" == *"audio-segment"* ]]; then
            echo "  wrangler tail waveshift-audio-segment-worker --format pretty"
          fi
          if [[ "${{ github.event.inputs.container_service }}" == *"ffmpeg"* ]]; then
            echo "  wrangler tail waveshift-ffmpeg-worker --format pretty"
          fi
          echo ""
          echo "ğŸ§ª æµ‹è¯•å»ºè®®:"
          echo "  ä½¿ç”¨å‰ç«¯ç•Œé¢ä¸Šä¼ è§†é¢‘æ–‡ä»¶æµ‹è¯•å®Œæ•´æµç¨‹"