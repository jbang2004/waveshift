name: Deploy FC Denoise Service

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        type: boolean
        default: false
  push:
    paths:
      - 'fc-denoise-service/**'
      - '.github/workflows/deploy-fc-denoise.yml'

jobs:
  deploy-fc-denoise:
    runs-on: ubuntu-latest
    name: Build and Deploy FC Denoise Service
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-fc-denoise-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-fc-denoise-

      - name: Debug - Check secrets availability
        run: |
          echo "æ£€æŸ¥secretsæ˜¯å¦é…ç½®..."
          if [ -n "${{ secrets.ACR_USERNAME }}" ]; then
            echo "âœ… ACR_USERNAME is set"
          else
            echo "âŒ ACR_USERNAME is NOT set"
          fi
          if [ -n "${{ secrets.ACR_PASSWORD }}" ]; then
            echo "âœ… ACR_PASSWORD is set"
          else
            echo "âŒ ACR_PASSWORD is NOT set"
          fi

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./fc-denoise-service
          file: ./fc-denoise-service/Dockerfile
          push: true
          tags: |
            crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/fc-denoise:latest
            crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/fc-denoise:v5.0-minimal-local
            crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/fc-denoise:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          platforms: linux/amd64

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Set up Serverless Devs
        run: |
          # å®‰è£…Serverless Devs CLI
          npm install -g @serverless-devs/s
          
          # é…ç½®é˜¿é‡Œäº‘å‡­è¯
          s config add --AccessKeyID ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
                       --AccessKeySecret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }} \
                       --AccountID ${{ secrets.ALIYUN_ACCOUNT_ID }} \
                       --access default

      - name: Deploy to Function Compute
        run: |
          cd fc-denoise-service
          
          # æ›´æ–°é•œåƒæ ‡ç­¾ä¸ºæœ€æ–°æ„å»ºçš„ç‰ˆæœ¬
          sed -i "s|image:.*|image: crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/fc-denoise:${{ github.sha }}|" s.yaml
          
          # éƒ¨ç½²åˆ°FC
          s deploy -y --use-local

      - name: Verify deployment
        run: |
          echo "ğŸ¯ éªŒè¯FCéƒ¨ç½²..."
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "- é•œåƒ: crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/fc-denoise:${{ github.sha }}"
          echo "- å‡½æ•°å: fc-denoise-minimal"
          echo "- åŒºåŸŸ: ap-southeast-1"
          echo "- èµ„æº: 1GBå†…å­˜, 0.5 vCPU"
          echo ""
          echo "âœ… FCé™å™ªæœåŠ¡éƒ¨ç½²å®Œæˆï¼"

      - name: Test deployment
        if: success()
        run: |
          sleep 30  # ç­‰å¾…å‡½æ•°å¯åŠ¨
          echo "ğŸ§ª æµ‹è¯•éƒ¨ç½²çš„æœåŠ¡..."
          
          # æµ‹è¯•å¥åº·æ£€æŸ¥
          curl -f https://fc-deno-service-ppbixyajpa.ap-southeast-1.fcapp.run/health || echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ›´é•¿å¯åŠ¨æ—¶é—´"
          
          echo ""
          echo "ğŸ“ æµ‹è¯•å‘½ä»¤ï¼š"
          echo "curl -X POST 'https://fc-deno-service-ppbixyajpa.ap-southeast-1.fcapp.run/' \\"
          echo "  -H 'Content-Type: audio/wav' \\"
          echo "  --data-binary @test/test_audio.wav \\"
          echo "  --output denoised.wav"