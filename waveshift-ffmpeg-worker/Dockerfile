# ğŸ”¥ ä¼˜åŒ–çš„FFmpegå®¹å™¨ - ä¿®å¤å¯åŠ¨å´©æºƒé—®é¢˜
# ç›´æ¥ä½¿ç”¨åŒ…å«æ‰€æœ‰ä¾èµ–çš„FFmpegé•œåƒä½œä¸ºåŸºç¡€
FROM jrottenberg/ffmpeg:7.1-ubuntu2404 AS runtime-base

# å®‰è£…Rustå’Œæ„å»ºå·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    libssl-dev \
    file \
    libc-bin \
    && curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    && . ~/.cargo/env \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®Rustç¯å¢ƒ
ENV PATH="/root/.cargo/bin:${PATH}"

# å¤åˆ¶æºä»£ç åˆ°å®¹å™¨
WORKDIR /app
COPY separate-container/Cargo.toml separate-container/Cargo.lock ./
COPY separate-container/src ./src

# æ„å»ºRuståº”ç”¨
RUN . ~/.cargo/env && cargo build --release

# è®¾ç½®æ‰§è¡Œæƒé™
RUN chmod +x /app/target/release/separate-container

# åˆ›å»ºè½¯é“¾æ¥åˆ° /app ç›®å½•
RUN ln -sf /app/target/release/separate-container /app/separate-container

# éªŒè¯FFmpegå¯ç”¨æ€§
RUN ffmpeg -version && ffprobe -version

# éªŒè¯Ruståº”ç”¨å¯æ‰§è¡Œ
RUN file /app/separate-container || echo "fileå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡æ–‡ä»¶ç±»å‹æ£€æŸ¥" \
    && ldd /app/separate-container || echo "lddå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡ä¾èµ–æ£€æŸ¥"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# æš´éœ²ç«¯å£
EXPOSE 8080

# æ·»åŠ å¯åŠ¨è„šæœ¬è¿›è¡Œè°ƒè¯•
RUN echo '#!/bin/bash\n\
echo "ğŸš€ Containerå¯åŠ¨è°ƒè¯•ä¿¡æ¯"\n\
echo "å½“å‰ç›®å½•: $(pwd)"\n\
echo "æ–‡ä»¶åˆ—è¡¨: $(ls -la)"\n\
echo "FFmpegç‰ˆæœ¬: $(ffmpeg -version | head -1)"\n\
echo "ç«¯å£æ£€æŸ¥: $(netstat -tlnp 2>/dev/null | grep :8080 || echo \"ç«¯å£8080æœªå ç”¨\")"\n\
echo "å¯åŠ¨Ruståº”ç”¨..."\n\
exec "./separate-container"\n' > /app/start.sh && chmod +x /app/start.sh

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# ä½¿ç”¨å¯åŠ¨è„šæœ¬
CMD ["/app/start.sh"]