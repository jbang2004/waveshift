# ğŸš€ FCé™å™ªæœåŠ¡ - 4vCPUç»ˆæä¼˜åŒ–é…ç½® (å®Œæ•´ç‰ˆ)
FROM python:3.10-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶requirementsæ–‡ä»¶
COPY requirements.txt /app/requirements.txt

# å®‰è£…ç³»ç»Ÿä¾èµ–å’ŒPythonä¾èµ–
RUN apt-get update && apt-get install -y \
    libsndfile1 \
    libsox-fmt-all \
    sox \
    ffmpeg \
    wget \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && pip install --no-cache-dir \
    --trusted-host pypi.org \
    --trusted-host pypi.python.org \
    --trusted-host files.pythonhosted.org \
    --trusted-host download.pytorch.org \
    -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç å’Œæ¨¡å‹
COPY src/ /app/
COPY models/ /app/models/

# ğŸ¯ 4vCPUç»ˆæä¼˜åŒ–é…ç½® - åŸºäºå®Œæ•´æµ‹è¯•éªŒè¯
# ç³»ç»Ÿçº§çº¿ç¨‹é…ç½®
ENV OMP_NUM_THREADS=4
ENV MKL_NUM_THREADS=4
ENV TORCH_NUM_THREADS=4

# ONNX Runtime 4vCPUç»ˆæä¼˜åŒ–é…ç½®
# åŸºäºæµ‹è¯•éªŒè¯çš„æœ€ä¼˜å‚æ•°:
# Intra-op: 3çº¿ç¨‹ (ä¸»è®¡ç®—ä¼˜åŒ–)
# Inter-op: 2çº¿ç¨‹ (æ“ä½œé—´å¹¶è¡Œ)
ENV ORT_INTRA_OP_NUM_THREADS=3
ENV ORT_INTER_OP_NUM_THREADS=2

# ğŸš€ FC 3.0ä¼˜åŒ–é…ç½®
# å¯ç”¨Initializerå›è°ƒé¢„çƒ­ï¼Œæ¶ˆé™¤é¦–æ¬¡è¯·æ±‚å»¶è¿Ÿ
ENV FC_ENABLE_MODEL_PRELOAD=true
ENV FC_ENABLE_INFERENCE_WARMUP=true

# ğŸ·ï¸ é…ç½®æ ‡è¯†
ENV CPU_CONFIG=4vcpu
ENV PERFORMANCE_MODE=ultimate
ENV FC_OPTIMIZATION=initializer-preload

# ğŸ“Š éªŒè¯çš„æ€§èƒ½æŒ‡æ ‡ (FC 3.0ä¼˜åŒ–å)
# é¦–æ¬¡è¯·æ±‚: 15ç§’ â†’ 7-10ç§’ (Initializeré¢„çƒ­)
# åç»­è¯·æ±‚: 7-10ç§’ (æ¨¡å‹å¤ç”¨)
# å®ä¾‹å¤ç”¨ç‡: >90% (audio-segmentæµå¼åœºæ™¯)
# FCä¼˜åŒ–çº§åˆ«: Maximum (Initializer + æ¨¡å‹é¢„çƒ­ + ç›‘æ§)

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["python", "fc_denoise_server.py"]