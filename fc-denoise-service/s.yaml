# Serverless Devs 配置文件
# 用于部署阿里云函数计算3.0自定义容器服务 - 极简版本

edition: 3.0.0          # Serverless Devs版本
name: fc-denoise-minimal-app    # 应用名称
access: default         # 访问凭证配置名称

vars:
  region: ap-southeast-1   # 🌏 阿里云区域 (新加坡，与ACR同区域)
  functionName: fc-denoise-minimal

resources:
  fc-denoise-minimal:   # 服务名称
    component: fc3      # 使用FC 3.0组件
    props:
      region: ${vars.region}
      
      # 函数配置
      function:
        functionName: ${vars.functionName}
        description: "ZipEnhancer极简降噪服务 - 30行代码，本地模型，11x实时处理速度"
        
        # 运行时配置
        runtime: custom-container
        
        # 自定义容器配置
        customContainerConfig:
          # 🎯 容器镜像地址（极简版本 - 仅3个依赖 + 本地模型）
          image: crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/fc-denoise:v5.0-minimal-local
          port: 9000
          command: ["python", "-m", "src.fc_denoise"]
        
        # 🔧 资源配置（极简优化 - 资源需求大幅降低）
        memorySize: 1024    # 1GB内存（极简版足够）
        cpu: 0.5           # 0.5 vCPU（性能已足够）
        timeout: 60        # 1分钟超时（处理更快）
        
        # 环境变量 - 极简配置
        environmentVariables:
          PYTHONUNBUFFERED: "1"
          OMP_NUM_THREADS: "1"
          MKL_NUM_THREADS: "1"
          # 🎯 本地模型路径（无需下载）
          MODEL_PATH: "/app/models/"
          
        # 🌐 网络配置
        internetAccess: true
        
        # 📊 日志配置
        logConfig:
          project: fc-denoise-pytorch-logs
          logstore: function-logs
          enableRequestMetrics: true
          enableInstanceMetrics: true
        
        # 🚀 实例配置（PyTorch版本优化）
        instanceConcurrency: 2      # 提升并发（性能更好）
        instanceType: e1           # 经济型实例
        
        # 🔥 生产环境预热配置 (可选)
        # provisionedConcurrencyConfig:
        #   target: 1                 # 预留1个实例用于消除冷启动
        #   scheduledActions:         # 定时伸缩规则
        #     - name: "peak-hours"
        #       schedule: "0 9 * * *"  # 每天9点预热
        #       target: 2
        #     - name: "off-hours" 
        #       schedule: "0 22 * * *" # 每天22点缩容
        #       target: 0
        
        # 性能优化配置
        initializationTimeout: 30   # 初始化超时（模型加载更快）
        
      # HTTP触发器配置
      triggers:
        - name: http-trigger
          type: http
          config:
            authType: anonymous     # 🔓 匿名访问（生产环境建议改为function）
            methods:
              - GET
              - POST
              - OPTIONS
            # CORS配置
            cors:
              allowOrigin: "*"
              allowMethods: 
                - GET
                - POST
                - OPTIONS
              allowHeaders:
                - Content-Type
                - X-Segment-Id
                - X-Speaker
                - X-Enable-Streaming
                - X-Input-Format
              maxAge: 3600