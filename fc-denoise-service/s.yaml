# Serverless Devs é…ç½®æ–‡ä»¶
# ç”¨äºéƒ¨ç½²é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—3.0è‡ªå®šä¹‰å®¹å™¨æœåŠ¡ - æç®€ç‰ˆæœ¬

edition: 3.0.0          # Serverless Devsç‰ˆæœ¬
name: fc-denoise-minimal-app    # åº”ç”¨åç§°
access: default         # è®¿é—®å‡­è¯é…ç½®åç§°

vars:
  region: ap-southeast-1   # ğŸŒ é˜¿é‡Œäº‘åŒºåŸŸ (æ–°åŠ å¡ï¼Œä¸ACRåŒåŒºåŸŸ)
  functionName: fc-denoise-minimal

resources:
  fc-denoise-minimal:   # æœåŠ¡åç§°
    component: fc3      # ä½¿ç”¨FC 3.0ç»„ä»¶
    props:
      region: ${vars.region}
      
      # å‡½æ•°é…ç½®
      function:
        functionName: ${vars.functionName}
        description: "ZipEnhanceræç®€é™å™ªæœåŠ¡ - 30è¡Œä»£ç ï¼Œæœ¬åœ°æ¨¡å‹ï¼Œ11xå®æ—¶å¤„ç†é€Ÿåº¦"
        
        # è¿è¡Œæ—¶é…ç½®
        runtime: custom-container
        
        # è‡ªå®šä¹‰å®¹å™¨é…ç½®
        customContainerConfig:
          # ğŸ¯ å®¹å™¨é•œåƒåœ°å€ï¼ˆæç®€ç‰ˆæœ¬ - ä»…3ä¸ªä¾èµ– + æœ¬åœ°æ¨¡å‹ï¼‰
          image: crpi-nw2oorfhcjjmm5o0.ap-southeast-1.personal.cr.aliyuncs.com/waveshifttts/fc-denoise:v5.0-minimal-local
          port: 9000
          command: ["python", "-m", "src.fc_denoise"]
        
        # ğŸ”§ èµ„æºé…ç½®ï¼ˆæç®€ä¼˜åŒ– - èµ„æºéœ€æ±‚å¤§å¹…é™ä½ï¼‰
        memorySize: 1024    # 1GBå†…å­˜ï¼ˆæç®€ç‰ˆè¶³å¤Ÿï¼‰
        cpu: 0.5           # 0.5 vCPUï¼ˆæ€§èƒ½å·²è¶³å¤Ÿï¼‰
        timeout: 60        # 1åˆ†é’Ÿè¶…æ—¶ï¼ˆå¤„ç†æ›´å¿«ï¼‰
        
        # ç¯å¢ƒå˜é‡ - æç®€é…ç½®
        environmentVariables:
          PYTHONUNBUFFERED: "1"
          OMP_NUM_THREADS: "1"
          MKL_NUM_THREADS: "1"
          # ğŸ¯ æœ¬åœ°æ¨¡å‹è·¯å¾„ï¼ˆæ— éœ€ä¸‹è½½ï¼‰
          MODEL_PATH: "/app/models/"
          
        # ğŸŒ ç½‘ç»œé…ç½®
        internetAccess: true
        
        # ğŸ“Š æ—¥å¿—é…ç½®
        logConfig:
          project: fc-denoise-pytorch-logs
          logstore: function-logs
          enableRequestMetrics: true
          enableInstanceMetrics: true
        
        # ğŸš€ å®ä¾‹é…ç½®ï¼ˆPyTorchç‰ˆæœ¬ä¼˜åŒ–ï¼‰
        instanceConcurrency: 2      # æå‡å¹¶å‘ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
        instanceType: e1           # ç»æµå‹å®ä¾‹
        
        # ğŸ”¥ ç”Ÿäº§ç¯å¢ƒé¢„çƒ­é…ç½® (å¯é€‰)
        # provisionedConcurrencyConfig:
        #   target: 1                 # é¢„ç•™1ä¸ªå®ä¾‹ç”¨äºæ¶ˆé™¤å†·å¯åŠ¨
        #   scheduledActions:         # å®šæ—¶ä¼¸ç¼©è§„åˆ™
        #     - name: "peak-hours"
        #       schedule: "0 9 * * *"  # æ¯å¤©9ç‚¹é¢„çƒ­
        #       target: 2
        #     - name: "off-hours" 
        #       schedule: "0 22 * * *" # æ¯å¤©22ç‚¹ç¼©å®¹
        #       target: 0
        
        # æ€§èƒ½ä¼˜åŒ–é…ç½®
        initializationTimeout: 30   # åˆå§‹åŒ–è¶…æ—¶ï¼ˆæ¨¡å‹åŠ è½½æ›´å¿«ï¼‰
        
      # HTTPè§¦å‘å™¨é…ç½®
      triggers:
        - name: http-trigger
          type: http
          config:
            authType: anonymous     # ğŸ”“ åŒ¿åè®¿é—®ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®æ”¹ä¸ºfunctionï¼‰
            methods:
              - GET
              - POST
              - OPTIONS
            # CORSé…ç½®
            cors:
              allowOrigin: "*"
              allowMethods: 
                - GET
                - POST
                - OPTIONS
              allowHeaders:
                - Content-Type
                - X-Segment-Id
                - X-Speaker
                - X-Enable-Streaming
                - X-Input-Format
              maxAge: 3600