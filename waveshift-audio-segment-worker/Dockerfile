# ğŸš€ ä¼˜åŒ–å¤šé˜¶æ®µæ„å»º - Alpineæ„å»ºç¯å¢ƒå…¼å®¹æ€§ä¼˜åŒ–
# æ„å»ºé˜¶æ®µ - Alpine + musl é™æ€é“¾æ¥
FROM rust:alpine AS builder

# å®‰è£…Alpineæ„å»ºä¾èµ–
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    openssl-libs-static

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ Rust é¡¹ç›®æ–‡ä»¶
COPY audio-segment-container/Cargo.toml ./
COPY audio-segment-container/src ./src

# æ·»åŠ musl targetå¹¶æ„å»ºé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶
RUN rustup target add x86_64-unknown-linux-musl
RUN cargo build --release --target x86_64-unknown-linux-musl

# ğŸ¬ è¿è¡Œé˜¶æ®µ - Alpine FFmpeg è½»é‡çº§é•œåƒ
# ä¼˜åŠ¿: Alpine Linux + FFmpegï¼Œä»…106MBï¼Œå¯åŠ¨æ›´å¿«ï¼Œæ›´é€‚åˆäº‘ç¯å¢ƒ
FROM alfg/ffmpeg

# å®‰è£…å¿…è¦çš„ä¾èµ–ï¼ˆåœ¨Alpineä¸­ï¼‰
RUN apk add --no-cache ca-certificates

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆmuslé™æ€é“¾æ¥ï¼‰
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/audio-segment-container ./audio-segment-container

# ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶å¯æ‰§è¡Œ
RUN chmod +x ./audio-segment-container

# éªŒè¯FFmpegæ˜¯å¦å¯ç”¨å¹¶è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
RUN ffmpeg -buildconf

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD wget -qO- http://localhost:8080/health || exit 1

# å¯åŠ¨å‰è¯Šæ–­
RUN echo "ğŸ” å¯åŠ¨å‰è¯Šæ–­ä¿¡æ¯:" && \
    echo "ğŸ“¦ é•œåƒæ¶æ„: Alpine Linux + FFmpeg" && \
    ls -la /app/ && \
    echo "âœ… éŸ³é¢‘åˆ‡åˆ†å®¹å™¨ (Rustç‰ˆ) å‡†å¤‡å°±ç»ª"

# è¿è¡Œåº”ç”¨
CMD ["./audio-segment-container"]