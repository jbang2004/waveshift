# ä½¿ç”¨å®˜æ–¹PythonåŸºç¡€é•œåƒ
FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ffmpegå’Œå¿…éœ€çš„éŸ³é¢‘ç¼–è§£ç å™¨
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libavcodec-extra \
    curl \
    && rm -rf /var/lib/apt/lists/*

# éªŒè¯ffmpegå’Œffprobeå¯ç”¨æ€§
RUN ffmpeg -version && ffprobe -version
RUN ffmpeg -codecs | grep aac && echo "âœ… AAC codec available"

# å¤åˆ¶requirementsæ–‡ä»¶
COPY audio-segment-container/requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶æºä»£ç 
COPY audio-segment-container/src/ ./src/

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH="/app"
ENV PYTHONUNBUFFERED=1

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# å¯åŠ¨å‰è¯Šæ–­
RUN echo "ğŸ” å¯åŠ¨å‰è¯Šæ–­ä¿¡æ¯:" && \
    python --version && \
    ls -la /app/src/ && \
    python -c "import fastapi, uvicorn; print('âœ… åŸºç¡€ä¾èµ–å¯¼å…¥æˆåŠŸ')" && \
    echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•: $(pwd)" && \
    echo "ğŸ Pythonè·¯å¾„: $PYTHONPATH"

# å¯åŠ¨å‘½ä»¤ - ä½¿ç”¨ç»å¯¹è·¯å¾„å’Œè¯¦ç»†é”™è¯¯è¾“å‡º
CMD ["python", "-u", "/app/src/main.py"]