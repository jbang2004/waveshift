# ğŸš€ ç”Ÿäº§ç‰ˆæœ¬ - åŸºäºæˆåŠŸçš„Alpineé…ç½®æ·»åŠ FastAPI
FROM python:3.11-alpine

WORKDIR /app

# å®‰è£…Alpineç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    wget \
    ca-certificates \
    gcc \
    g++ \
    musl-dev \
    libffi-dev \
    libsndfile-dev

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements_alpine.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements_alpine.txt

# å¤åˆ¶æ‰€æœ‰æœåŠ¡å™¨ä»£ç 
COPY minimal_server.py .
COPY fastapi_server.py .
COPY audio_server.py .
COPY denoise_server.py .
COPY denoise_alpine.py .
COPY zipenhancer_streaming.py .

# å¤åˆ¶æ¨¡å‹æ–‡ä»¶
COPY speech_zipenhancer_ans_multiloss_16k_base/ ./speech_zipenhancer_ans_multiloss_16k_base/

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV OMP_NUM_THREADS=2
ENV MKL_NUM_THREADS=2

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥ï¼ˆä½¿ç”¨wgetï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=20s --retries=3 \
    CMD wget -qO- http://localhost:8080/health || exit 1

# ğŸ¯ å…ˆéªŒè¯éŸ³é¢‘å¤„ç†ï¼Œç¡®è®¤æœ‰å£°éŸ³è¾“å‡º
CMD ["python", "audio_server.py"]